---
import { addDays, subDays } from 'date-fns';
import { formatDate } from 'src/utilities/locale/date';
import { availableLocales, Locale } from 'src/utilities/locale/translation';
import {
	getDataSituationAdvice,
	PageSituationAdviceProps,
} from 'src/utilities/api';

import Layout from '../../../layouts/Layout.astro';
import ContentBlock from 'src/components/ContentBlock.astro';

export async function getStaticPaths() {
	return await availableLocales.reduce(async (paths, locale) => {
		const { pages } = await getDataSituationAdvice({ locale });

		// loop over pages to get days to generate
		const newPaths = pages.map((page) => {
			const answerDays =
				page.answer &&
				page.answer.filter(
					(answer) => !!answer.showOn && answer.showOn.length > 0,
				).length
					? [
							...new Set(
								[].concat(...page.answer.map((answer) => answer.showOn)),
							),
					  ]
					: [0];

			const planDays =
				page?.advice.plan &&
				page.advice.plan.filter(({ showOn }) => !!showOn).length
					? [
							...new Set(
								[].concat(...page.advice.plan.map(({ showOn }) => showOn)),
							),
					  ]
					: [0];

			const daysToGenerate = [...new Set(answerDays.concat(planDays))];

			return daysToGenerate.map((day) => ({
				params: {
					slug: `${page.slug}${day === 0 ? '' : `-dag-${day}`}`,
					locale: locale.id,
				},
				props: {
					pageData: page,
					pageDay: day,
					locale,
				},
			}));
		});

		return [...(await paths), newPaths.flat()];
	}, Promise.resolve([]));
}

interface Props {
	pageData: PageSituationAdviceProps;
	locale: Locale;
	pageDay: number;
}

const { pageData, locale, pageDay } = Astro.props;

const today = new Date();

// Filter advice plan based on current day
const plan =
	pageData?.advice.plan &&
	pageData.advice.plan
		.filter(({ showOn }) => !showOn || showOn.includes(pageDay))
		.map(({ content, day: planDay, title }) => ({
			content,
			day: planDay,
			title,
			date:
				planDay === null || planDay === undefined
					? formatDate(today, locale.locale)
					: formatDate(
							planDay > pageDay
								? addDays(today, planDay - pageDay)
								: subDays(today, pageDay - planDay),
							locale.locale,
					  ),
		}));

console.log('pageData', pageData);
---

<Layout locale={locale} metaData={pageData.metaData}>
	<main>
		<h1>{pageData.header.title}</h1>
		<p><mark>{locale.fullName}</mark></p>

		{
			pageData.answer.map((answer) => {
				if (!answer.showOn.includes(pageDay)) return null;
				return (
					<>
						<h2>{answer.title}</h2>
						<ContentBlock portableText={answer.content} />
					</>
				);
			})
		}

		<h2>{pageData.advice.title}</h2>
		{
			plan.map(({ date, title, content }) => {
				return (
					<>
						<h3>{title}</h3>
						<p>Dag: {date}</p>
						{content && <ContentBlock portableText={content} />}
					</>
				);
			})
		}
	</main>
</Layout>

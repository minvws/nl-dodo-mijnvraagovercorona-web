---
import type { HTMLAttributes } from 'astro/types';
import { Card } from '@design-system/components/Card';
import { MediaBlock } from '@design-system/components/MediaBlock';
import type { ContentBlockProps } from '@design-system/components/ContentBlock';
import { ContentBlock } from '@design-system/components/ContentBlock';
import { Stack } from '../Layout/Stack';
import type { ButtonProps } from 'src/utilities/api/queries/buttons';
import type { ImageProps } from 'src/utilities/api/queries';
import { Disclosure, DisclosureItem } from '../Disclosure';
import { FlexibleButton } from '@modules/elements/FlexibleButton';

interface Props extends HTMLAttributes<'div'> {
	title: string;
	image?: ImageProps;
	content: ContentBlockProps['value'];
	button?: ButtonProps;
	items?: {
		image?: ImageProps;
		content: ContentBlockProps['value'];
	}[];
}

const { title, image, content, button, items } = Astro.props;
---

<Card variant="filled" class="c-advice-block">
	<Stack gap={4}>
		<Disclosure>
			<DisclosureItem
				headingLevel={3}
				label={title}
				id={title}
				accordeon
				adviceBlock
				itemscope
				itemprop="mainEntity"
				itemtype="https://schema.org/Question"
				image={image}
			>
				<Stack gap={8}>
					<ContentBlock value={content} />
					{
						items.map((item) => (
							<MediaBlock icon={item.image} class="c-advice-block__media-item">
								<ContentBlock value={item.content} />
							</MediaBlock>
						))
					}
					{
						button?.label ? (
							<FlexibleButton {...button} interactionIconAnimation="swing" />
						) : null
					}
				</Stack>
			</DisclosureItem>
		</Disclosure>
	</Stack>
</Card>

<style lang="scss">
	@use '@design-system-styles/primitives/_responsive.scss';

	/**
	 * 1. override specificity by 0,1,0 to battle Astro loading
	 */
	.c-advice-block.c-advice-block {
		--card-border-width: var(--space-1);
		--card-border-color: var(--color-accent-grasgroen);
		padding: 0;
		border-block-start: 0;
		border-block-end: 0;
		border-inline-end: 0;
		border-radius: var(--space-1);

		&:nth-of-type(even) {
			--card-border-color: var(--color-accent-robijnrood);
		}
		@media (--mq-large) {
			:global(.disclosure__item--accordeon .disclosure__panel-inner) {
				padding-block-start: 0;
			}
		}
	}

	.c-advice-block__media-item {
		@media (--mq-large) {
			margin-inline-start: var(--space-3);
		}
	}
</style>
<script>
	import { mqLarge } from '@design-system/primitives/responsive';

	const mql = window.matchMedia(mqLarge);

	const disclosureItems = [
		...document.querySelectorAll('[data-module-bind="disclosure__item"]'),
	];

	const disclosureToggles = [
		...document.querySelectorAll<HTMLButtonElement>('.advice-block__button'),
	];

	const setToggleTabIndex = (toggle: HTMLButtonElement) => {
		toggle.setAttribute('tabindex', '-1');
	};

	const unsetToggleTabIndex = (toggle: HTMLButtonElement) => {
		toggle.removeAttribute('tabindex');
	};

	const setAriaExpanded = (toggle: HTMLButtonElement) => {
		toggle.setAttribute('aria-expanded', 'true');
	};

	const unsetAriaExpanded = (toggle: HTMLButtonElement) => {
		toggle.setAttribute('aria-expanded', 'false');
	};

	const setPanelBlockSize = () => {
		disclosureItems.forEach((item) => {
			const itemPanel = item.querySelector('.disclosure__panel') as HTMLElement;
			itemPanel.style.blockSize = 'auto';
		});
	};

	const unsetPanelBlockSize = () => {
		disclosureItems.forEach((item) => {
			const itemPanel = item.querySelector('.disclosure__panel') as HTMLElement;
			itemPanel.style.blockSize = '0';
		});
	};

	const toggleDisclosure = (matches: boolean) => {
		if (matches) {
			disclosureToggles.forEach(setToggleTabIndex);
			disclosureToggles.forEach(setAriaExpanded);
			disclosureItems.forEach((item) => {
				item.classList.add('is-active');
			});
			setPanelBlockSize();
		} else {
			disclosureToggles.forEach(unsetToggleTabIndex);
			disclosureToggles.forEach(unsetAriaExpanded);
			disclosureItems.forEach((item) => {
				item.classList.remove('is-active');
			});
			unsetPanelBlockSize();
		}
	};

	mql.addEventListener('change', (event) => {
		toggleDisclosure(event.matches);
	});

	toggleDisclosure(mql.matches);
</script>

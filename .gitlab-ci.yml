default:
  tags:
    - default

variables:
  CD_NAMESPACE_BHR: vws-reis-bhr
  CD_HARBOR_REGISTRY: harbor.cicd.s15m.nl

image: harbor.cicd.s15m.nl/vws-reis/tool-box:1.2

.build-image: &build-image
  environment:
    name: 'test-cluster'
  stage: package
  image:
    name: gcr.io/kaniko-project/executor:v1.3.0-debug
    entrypoint: ['']
  script:
    - echo "${DOCKER_AUTH_CONFIG}" > /kaniko/.docker/config.json
    - cat /kaniko/.docker/config.json
    - cat ./packages/${CD_APP_FOLDER}/Dockerfile |
      sed "s~node:18-alpine~harbor.cicd.s15m.nl/vws-reis-docker-hub/library/node:18-alpine~g"
      > ./packages/${CD_APP_FOLDER}/Dockerfile_derived
    - cat ./packages/${CD_APP_FOLDER}/Dockerfile_derived
    - echo "CI_PROJECT_DIR ${CI_PROJECT_DIR}"
    - pwd
    - 'echo ${CD_HARBOR_REGISTRY}/vws-reis/${CD_APP_NAME}:${CD_APP_TAG}'
    - /kaniko/executor
      --context ${CI_PROJECT_DIR}
      --dockerfile /packages/${CD_APP_FOLDER}/Dockerfile_derived
      --build-arg buildid=${CD_APP_TAG}
      --destination ${CD_HARBOR_REGISTRY}/vws-reis/${CD_APP_NAME}:${CD_APP_TAG}
      --cache=true

.label-image: &label-image
  environment:
    name: overheid-test4
  stage: label
  image: harbor.cicd.s15m.nl/vws-reis/tool-box:1.2
  script:
    - CD_USERNAME=${HARBOR_ROBOT_NAME}
    - CD_PASSWORD=$(echo ${HARBOR_ROBOT_SECRET} | base64 -d)
    - "CONTENT_HEADER='Content-Type:application/json'"
    - curl -v -u "${CD_USERNAME}:${CD_PASSWORD}" -H ${CONTENT_HEADER} https://${CD_HARBOR_REGISTRY}/api/repositories/vws-reis/${CD_APP_NAME}/tags/${CD_APP_TAG}/labels -d '{"id":${CD_ENVIRONMENT_LABEL}}'

stages:
  - test
  - build
  - package
  - label
  - deploy

before_script:
  - echo "Started by ${GITLAB_USER_LOGIN} at $(date +%Y-%m-%d'-'%H-%M-%S)"
  - export CD_APP_TAG=$(date -d "$(echo $CI_PIPELINE_CREATED_AT | sed 's/T/ /; s/Z//')" +%Y%m%d%H%M)
  - echo ${CI_PIPELINE_CREATED_AT}
  - echo ${CD_APP_TAG}
  - unset ${HISTFILE} # Disable shell cache for security purposes

test mvoc:
  image: harbor.cicd.s15m.nl/vws-reis-docker-hub/library/node:18-alpine
  stage: test
  script:
    - npm ci
    - npm run mvoc:test
  only:
    - develop
    - main
    - staging

label mvoc image staging:
  <<: *label-image
  variables:
    CD_APP_NAME: mijn-vraag-over-corona-website
    CD_ENVIRONMENT_LABEL: 2
  only:
    - staging

label mvoc image production:
  <<: *label-image
  variables:
    CD_APP_NAME: mijn-vraag-over-corona-website
    CD_ENVIRONMENT_LABEL: 1
  only:
    - main

build mvoc:
  image: harbor.cicd.s15m.nl/vws-reis-docker-hub/library/node:18-alpine
  stage: build
  script:
    - npm ci --production
    - npm run mvoc:build
    - mkdir -p artifacts
    - cp -r packages/mvoc/dist artifacts/
  artifacts:
    paths:
      - artifacts/dist/
  only:
    - develop
    - main
    - staging

build mvoc image:
  <<: *build-image
  variables:
    CD_APP_NAME: mijn-vraag-over-corona-website
    CD_APP_FOLDER: mvoc
  before_script:
    - mkdir -p packages/mvoc
    - cp -r artifacts/dist packages/mvoc/
  dependencies:
    - build mvoc
  only:
    - develop
    - main
    - staging

deploy mvoc image latest:
  variables:
    CD_APP_NAME: mijn-vraag-over-corona-website
    CD_PIPELINE_CREATED_AT: $CI_PIPELINE_CREATED_AT
    CD_ENVIRONMENT: development
  stage: deploy
  trigger:
    project: vws/reis/nl-covid19-travel-during-corona-deploy
    branch: develop
    forward:
      pipeline_variables: true
  only:
    - develop

deploy mvoc image staging:
  variables:
    CD_APP_NAME: mijn-vraag-over-corona-website
    CD_PIPELINE_CREATED_AT: $CI_PIPELINE_CREATED_AT
    CD_ENVIRONMENT: staging
  stage: deploy
  trigger:
    project: vws/reis/nl-covid19-travel-during-corona-deploy
    branch: develop
    forward:
      pipeline_variables: true
  only:
    - staging

deploy mvoc image production:
  variables:
    CD_APP_NAME: mijn-vraag-over-corona-website
    CD_PIPELINE_CREATED_AT: $CI_PIPELINE_CREATED_AT
    CD_ENVIRONMENT: production
  stage: deploy
  trigger:
    project: vws/reis/nl-covid19-travel-during-corona-deploy
    branch: develop
    forward:
      pipeline_variables: true
  only:
    - main
